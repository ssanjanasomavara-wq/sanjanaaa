<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Semi‑Colonic — Home</title>

  <style>
    :root {
      --night-bg: #0b1324;
      --night-card: #121b34;
      --blue: #7aa2ff;
      --blue-soft: #a9c0ff;
      --text-light: #eef1ff;
      --muted-light: #9aa6d9;
      --sea: #6fa9c9;
      --foam: #d6ecf6;
      --sand: #e2b07a;
      --clay: #c87a3c;
      --earth-text: #2a2a2a;
    }
    * { box-sizing: border-box; }
    body { margin:0; min-height:100vh; font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; display:flex; align-items:center; justify-content:center; padding:24px; }
    .container { width:100%; max-width:420px; padding:26px; text-align:center; animation:fadeIn 1.2s ease; }
    .logo { font-size:2.6rem; font-weight:600; margin-bottom:10px; }
    .logo span { color: currentColor; }
    button { width:100%; padding:14px; border-radius:16px; border:none; font-size:0.95rem; font-weight:600; cursor:pointer; margin-top:10px; }
    .link { margin-top:14px; font-size:0.85rem; cursor:pointer; text-decoration:underline; }
    .message { margin-top:10px; font-size:0.9rem; }
    input { width:100%; padding:12px; margin-bottom:10px; border-radius:12px; border:none; background:rgba(255,255,255,0.05); }
    body.login { background: radial-gradient(900px 500px at 50% -20%, #1b2550, transparent), var(--night-bg); color: var(--text-light); }
    .login .subtitle { font-size:0.85rem; letter-spacing:0.6px; color:var(--muted-light); margin-bottom:6px; }
    .login .card { background: linear-gradient(180deg,#16204a,var(--night-card)); border-radius:22px; padding:26px 22px; box-shadow:0 18px 45px rgba(0,0,0,0.45); }
    .login input { background:#0f1733; color:var(--text-light); }
    .login button { background: linear-gradient(90deg,var(--blue),var(--blue-soft)); color:#ffffff; }
    .login .link { color: var(--blue-soft); }
    body.home { background: radial-gradient(800px 500px at 50% -10%, var(--foam), transparent), linear-gradient(180deg,var(--sea),#4e8fae); color:var(--earth-text); }
    .home .card { background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.75)); backdrop-filter: blur(6px); border-radius:22px; padding:26px 22px; box-shadow:0 18px 45px rgba(0,0,0,0.12); }
    .home .logo { color:#1f3f57; font-size:2.2rem; }
    .home strong { color: var(--clay); }
    .home button { background: linear-gradient(90deg,var(--sand),var(--clay)); color:#fff; }
    .footer { margin-top:16px; font-size:0.75rem; opacity:0.8; }
    .small { font-size:0.85rem; }
    .row { display:flex; gap:8px; }
    .row button { flex:1; }
    .hidden { display:none !important; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
  </style>
</head>
<body class="login">

  <div class="container" id="login">
    <div class="subtitle">Not the end—just a moment to rest.</div>
    <div class="logo">semi<span>;</span>colonic</div>

    <div class="card" id="login-card">
      <input id="email" type="email" placeholder="Email" autocomplete="username" />
      <input id="password" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="sign-in-btn" onclick="signIn()">Log in</button>

      <div class="row" style="margin-top:8px;">
        <button id="show-signup-btn" onclick="showSignUp()" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;">Sign up</button>
        <button onclick="guestEnter()" style="background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;">Guest</button>
      </div>

      <div style="display:flex; justify-content:center; gap:8px; margin-top:8px;">
        <button onclick="showForgot()" style="background:transparent;border:1px solid rgba(255,255,255,0.06);width:auto;padding:8px 12px;font-size:0.85rem;">Forgot Password?</button>
      </div>

      <div class="message" id="auth-message" aria-live="polite"></div>
    </div>
    <div class="footer">You’re safe to pause here.</div>
  </div>

  <div class="container hidden" id="signup">
    <div class="logo">semi<span>;</span>colonic</div>
    <div class="card">
      <input id="signup-email" type="email" placeholder="Email" autocomplete="email" />
      <input id="signup-password" type="password" placeholder="Password (min 6 chars)" autocomplete="new-password" />
      <input id="signup-password-confirm" type="password" placeholder="Confirm password" autocomplete="new-password" />
      <button id="create-account-btn" onclick="signUp()">Create account</button>
      <div class="row" style="margin-top:8px;">
        <button onclick="showLogin()" style="background:transparent;border:1px solid rgba(0,0,0,0.05);">Back</button>
      </div>
      <div class="message" id="signup-message" aria-live="polite"></div>
    </div>
    <div class="footer">You can come back anytime.</div>
  </div>

  <div class="container hidden" id="forgot">
    <div class="logo">semi<span>;</span>colonic</div>
    <div class="card">
      <p class="small">Enter your account email and we'll send a link to reset your password.</p>
      <input id="forgot-email" type="email" placeholder="Email" autocomplete="email" />
      <button onclick="sendResetEmail()">Send reset email</button>
      <div class="row" style="margin-top:8px;">
        <button onclick="showLogin()" style="background:transparent;border:1px solid rgba(0,0,0,0.05);">Back</button>
      </div>
      <div class="message" id="forgot-message" aria-live="polite"></div>
    </div>
    <div class="footer">Check your inbox — and your spam folder just in case.</div>
  </div>

  <div class="container hidden" id="reset">
    <div class="logo">semi<span>;</span>colonic</div>
    <div class="card">
      <p class="small" id="reset-desc">Choose a new password for your account.</p>
      <input id="reset-password" type="password" placeholder="New password (min 6 chars)" />
      <input id="reset-password-confirm" type="password" placeholder="Confirm new password" />
      <button id="reset-password-btn" onclick="resetPassword()">Reset password</button>
      <div class="row" style="margin-top:8px;">
        <button onclick="showLogin()" style="background:transparent;border:1px solid rgba(0,0,0,0.05);">Back</button>
      </div>
      <div class="message" id="reset-message" aria-live="polite"></div>
    </div>
    <div class="footer">If the link is expired, request a new reset email from the login view.</div>
  </div>

  <div class="container hidden" id="home">
    <div class="logo">semi<span>;</span>colonic</div>
    <div class="card">
      <p>
        <strong>What does a semicolon mean?</strong><br><br>
        A semicolon is used when a sentence could end — but doesn’t.
        It represents choosing to continue, even when stopping feels easier.
        <br><br>
        <strong>What is semi‑colonic?</strong><br><br>
        Semi‑colonic lives in the pause before that choice.
        This app is not about fixing yourself or being productive.
        It’s a place to rest, reflect, and continue gently.
      </p>
      <div class="row">
        <button id="enter-app" onclick="enterApp()">Enter app</button>
        <button id="sign-out-btn" style="background:#eee;color:#222" onclick="signOutUser()">Sign out</button>
      </div>
      <div class="message small" id="user-info"></div>
    </div>
    <div class="footer">The tide goes out. The tide comes back.</div>
  </div>

  <!-- Runtime Firebase bootstrap: fetch config from /api/firebase-config then import SDKs.
       Uses Firebase Authentication + Realtime Database (client-side modular SDK). -->
  <script type="module">
    // UI refs & helpers
    const loginEl = document.getElementById('login');
    const signupEl = document.getElementById('signup');
    const forgotEl = document.getElementById('forgot');
    const resetEl = document.getElementById('reset');
    const homeEl = document.getElementById('home');
    const authMessage = document.getElementById('auth-message');
    const signupMessage = document.getElementById('signup-message');
    const forgotMessage = document.getElementById('forgot-message');
    const resetMessage = document.getElementById('reset-message');
    const userInfo = document.getElementById('user-info');
    const resetDesc = document.getElementById('reset-desc');

    // Expose UI functions to the global scope so inline onclick handlers work.
    window.showSignUp = () => { loginEl.classList.add('hidden'); signupEl.classList.remove('hidden'); forgotEl.classList.add('hidden'); resetEl.classList.add('hidden'); window.clearMessages(); };
    window.showLogin = () => { signupEl.classList.add('hidden'); loginEl.classList.remove('hidden'); forgotEl.classList.add('hidden'); resetEl.classList.add('hidden'); window.clearMessages(); };
    window.showHome = () => { document.body.className='home'; loginEl.classList.add('hidden'); signupEl.classList.add('hidden'); homeEl.classList.remove('hidden'); forgotEl.classList.add('hidden'); resetEl.classList.add('hidden'); };
    window.showLoginView = () => { document.body.className='login'; homeEl.classList.add('hidden'); signupEl.classList.add('hidden'); loginEl.classList.remove('hidden'); forgotEl.classList.add('hidden'); resetEl.classList.add('hidden'); };
    window.showForgot = () => { loginEl.classList.add('hidden'); signupEl.classList.add('hidden'); forgotEl.classList.remove('hidden'); resetEl.classList.add('hidden'); window.clearMessages(); };
    window.showReset = () => { loginEl.classList.add('hidden'); signupEl.classList.add('hidden'); forgotEl.classList.add('hidden'); resetEl.classList.remove('hidden'); window.clearMessages(); };

    window.clearMessages = () => {
      authMessage.textContent = '';
      signupMessage.textContent = '';
      forgotMessage.textContent = '';
      resetMessage.textContent = '';
      userInfo.textContent = '';
    };

    window.guestEnter = () => { window.showHome(); userInfo.textContent = 'Guest — limited access.'; };
    window.enterApp = () => { alert('Entering the app — wire this up to your SPA / routing.'); };

    // --- Safe placeholders so clicking buttons before Firebase loads won't throw ---
    window.signUp = function() {
      signupMessage.textContent = 'Initializing authentication — please wait...';
      window.showSignUp();
    };
    window.signIn = function() {
      authMessage.textContent = 'Initializing authentication — please wait...';
      window.showLoginView();
    };
    window.signOutUser = function() {
      alert('Initializing authentication — please wait before signing out.');
    };
    window.sendResetEmail = function() {
      forgotMessage.textContent = 'Initializing authentication — please wait...';
      window.showForgot();
    };
    window.resetPassword = function() {
      resetMessage.textContent = 'Initializing authentication — please wait...';
      window.showReset();
    };
    // -------------------------------------------------------------------------

    // firebase instances after init
    let auth, db, currentOobCode = null, resetEmail = null;

    // Initialize Firebase by fetching config from serverless endpoint (Vercel)
    (async function initFirebase() {
      try {
        const resp = await fetch('/api/firebase-config', { cache: 'no-store' });
        if (!resp.ok) throw new Error('Failed to fetch firebase config: ' + resp.status);
        const firebaseConfig = await resp.json();

        // Dynamic import of modular SDKs
        const [{ initializeApp }, authMod, dbMod] = await Promise.all([
          import('https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js'),
          import('https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js'),
          import('https://www.gstatic.com/firebasejs/9.22.1/firebase-database.js')
        ]);

        const app = initializeApp(firebaseConfig);
        auth = authMod.getAuth(app);
        db = dbMod.getDatabase(app);

        // Auth & Realtime DB helpers we'll use
        const { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged,
                sendPasswordResetEmail, verifyPasswordResetCode, confirmPasswordReset } = authMod;
        const { ref, set, get, serverTimestamp } = dbMod;

        // Friendly error messages for common Firebase auth failures
        function friendlyAuthError(err) {
          const code = err && (err.code || (typeof err.message === 'string' && (err.message.match(/\(auth\/[^\)]+\)/) || [])[0]) || '');
          const normalized = (code || '').toString().replace(/^.*(auth\/)/, 'auth/').replace(/[()]/g, '').trim();

          switch (normalized) {
            case 'auth/wrong-password':
            case 'auth/invalid-login-credentials':
              return 'Incorrect email or password.';
            case 'auth/user-not-found':
              return 'No account found with that email.';
            case 'auth/invalid-email':
              return 'Please enter a valid email address.';
            case 'auth/user-disabled':
              return 'This account has been disabled.';
            case 'auth/email-already-in-use':
              return 'An account with that email already exists.';
            case 'auth/weak-password':
              return 'Password is too weak. Use at least 6 characters.';
            case 'auth/network-request-failed':
              return 'Network error — check your connection and try again.';
            case 'auth/expired-action-code':
            case 'auth/invalid-action-code':
              return 'The password reset link is invalid or has expired. Request a new link.';
            default:
              if (err && err.message) {
                const match = err.message.match(/Firebase:\s*Error\s*\((auth\/[^\)]+)\)\.?\s*(.*)/);
                if (match) return (match[2] && match[2].trim()) ? match[2].trim() : ('Authentication error: ' + match[1]);
                return err.message;
              }
              return 'Authentication failed. Please try again.';
          }
        }

        // Expose signUp, signIn, signOutUser to UI (they use auth/db from closure)
        window.signUp = async function signUp() {
          const email = document.getElementById('signup-email').value.trim();
          const password = document.getElementById('signup-password').value;
          const confirm = document.getElementById('signup-password-confirm').value;
          signupMessage.textContent = '';
          if (!email || !password) { signupMessage.textContent = 'Enter email and password.'; return; }
          if (password.length < 6) { signupMessage.textContent = 'Password must be at least 6 characters.'; return; }
          if (password !== confirm) { signupMessage.textContent = 'Passwords do not match.'; return; }

          try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // Create a minimal profile in Realtime Database under /users/{uid}
            const createdAt = (typeof serverTimestamp === 'function') ? serverTimestamp() : Date.now();
            await set(ref(db, `users/${user.uid}`), { email: user.email, createdAt });

            signupMessage.textContent = 'Account created — signing in...';
            // UI will be updated by onAuthStateChanged
          } catch (err) {
            signupMessage.textContent = friendlyAuthError(err);
          }
        };

        window.signIn = async function signIn() {
          const email = document.getElementById('email').value.trim();
          const password = document.getElementById('password').value;
          authMessage.textContent = '';
          if (!email || !password) { authMessage.textContent = 'Enter email and password.'; return; }
          try {
            await signInWithEmailAndPassword(auth, email, password);
            authMessage.textContent = 'Signed in — redirecting...';
          } catch (err) {
            authMessage.textContent = friendlyAuthError(err);
          }
        };

        window.signOutUser = async function signOutUser() {
          try {
            await signOut(auth);
            window.showLoginView();
          } catch (err) {
            alert('Sign out error: ' + (err.message || err));
          }
        };

        // Send password reset email (in-app)
        window.sendResetEmail = async function sendResetEmail() {
          const email = document.getElementById('forgot-email').value.trim();
          forgotMessage.textContent = '';
          if (!email) { forgotMessage.textContent = 'Enter your email.'; return; }

          try {
            // actionCodeSettings directs user to this site with mode=resetPassword
            const actionCodeSettings = {
              url: location.origin + location.pathname + '?mode=resetPassword',
              // If you want the reset to be handled in an iOS/Android app, configure here.
            };
            await sendPasswordResetEmail(auth, email, actionCodeSettings);
            forgotMessage.textContent = 'Reset email sent. Check your inbox.';
          } catch (err) {
            forgotMessage.textContent = friendlyAuthError(err);
          }
        };

        // Reset password using oobCode present in URL
        window.resetPassword = async function resetPassword() {
          const newPass = document.getElementById('reset-password').value;
          const confirm = document.getElementById('reset-password-confirm').value;
          resetMessage.textContent = '';
          if (!currentOobCode) { resetMessage.textContent = 'Reset code missing or invalid.'; return; }
          if (!newPass) { resetMessage.textContent = 'Enter a new password.'; return; }
          if (newPass.length < 6) { resetMessage.textContent = 'Password must be at least 6 characters.'; return; }
          if (newPass !== confirm) { resetMessage.textContent = 'Passwords do not match.'; return; }

          try {
            await confirmPasswordReset(auth, currentOobCode, newPass);
            resetMessage.textContent = 'Password updated. Signing you in...';
            // If we have the email from verifyPasswordResetCode, attempt to sign in automatically.
            if (resetEmail) {
              try {
                await signInWithEmailAndPassword(auth, resetEmail, newPass);
                resetMessage.textContent = 'Password updated and signed in.';
              } catch (err) {
                // If automatic sign-in fails, show a friendly message but not an error overlay.
                resetMessage.textContent = 'Password updated. Please sign in.';
              }
            } else {
              resetMessage.textContent = 'Password updated. Please sign in.';
            }
            // Push UI back to login after a short delay
            setTimeout(() => { showLogin(); }, 1600);
          } catch (err) {
            resetMessage.textContent = friendlyAuthError(err);
          }
        };

        // Read profile from Realtime DB and display minimal info
        async function loadUserProfile(uid) {
          try {
            const snapshot = await get(ref(db, `users/${uid}`));
            if (snapshot && snapshot.exists()) {
              const data = snapshot.val();
              const created = data.createdAt ? (typeof data.createdAt === 'number' ? new Date(data.createdAt).toLocaleString() : '[server timestamp]') : '';
              userInfo.textContent = `Signed in as ${data.email}${created ? ' — created ' + created : ''}`;
            } else {
              userInfo.textContent = 'Signed in — profile not found.';
            }
          } catch (err) {
            console.error('Failed to load profile:', err);
            userInfo.textContent = 'Signed in — failed to load profile.';
          }
        }

        // Keep UI in sync with auth state
        onAuthStateChanged(auth, (user) => {
          if (user) {
            window.showHome();
            loadUserProfile(user.uid);
          } else {
            // If no auth session but URL contains reset info, we'll show reset view below.
            // Otherwise show login view.
            const params = new URLSearchParams(location.search);
            const mode = params.get('mode');
            const oobCode = params.get('oobCode');
            if (mode === 'resetPassword' && oobCode) {
              // handled below by URL processing code (verify code)
            } else {
              window.showLoginView();
            }
          }
        });

        // Handle incoming URL for in-app reset flow: ?mode=resetPassword&oobCode=...&apiKey=...
        (async function handleUrlActions() {
          const params = new URLSearchParams(location.search);
          const mode = params.get('mode');
          const oobCode = params.get('oobCode');

          if (mode === 'resetPassword' && oobCode) {
            // Store the code so resetPassword() can use it
            currentOobCode = oobCode;
            try {
              // verifyPasswordResetCode returns the email address for that code
              const email = await verifyPasswordResetCode(auth, oobCode);
              resetEmail = email || null;
              resetDesc.textContent = `Resetting password for ${email}. Choose a new password.`;
              window.showReset();
            } catch (err) {
              // Show an error in reset view
              resetMessage.textContent = friendlyAuthError(err);
              window.showReset();
            }
          }
        })();

      } catch (err) {
        console.error(err);
        authMessage.textContent = 'Unable to initialize authentication. Check site configuration.';
      }
    })();
  </script>

</body>
</html>
